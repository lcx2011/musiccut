name: Build MusicCut (Win7 x86/x64)

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        arch: [x86, x64]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.8
        uses: actions/setup-python@v5
        with:
          python-version: "3.8"
          architecture: ${{ matrix.arch }}

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller==5.13.2

      - name: Prepare VLC
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if ("${{ matrix.arch }}" -eq "x86") {
            $url = "https://download.videolan.org/pub/videolan/vlc/3.0.9.2/win32/vlc-3.0.9.2-win32.zip"
          } else {
            $url = "https://download.videolan.org/pub/videolan/vlc/3.0.9.2/win64/vlc-3.0.9.2-win64.zip"
          }
          curl -L $url -o vlc.zip
          tar -xf vlc.zip
          $folder = (Get-ChildItem -Directory | Where-Object { $_.Name -like "vlc-3.0.9.2*" })[0].FullName
          Rename-Item $folder vlc

      - name: Prepare FFmpeg
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if ("${{ matrix.arch }}" -eq "x86") {
            $ff = "https://github.com/sudo-nautilus/FFmpeg-Builds-Win32/releases/download/latest/ffmpeg-master-latest-win32-gpl.zip"
          } else {
            $ff = "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip"
          }
          curl -L $ff -o ffmpeg.zip
          tar -xf ffmpeg.zip
          $ffdir = (Get-ChildItem -Directory -Recurse | Where-Object { Test-Path (Join-Path $_.FullName "bin") } | Select-Object -First 1).FullName
          Copy-Item -Path (Join-Path $ffdir "bin\*") -Destination "." -Recurse -Force

      - name: Build (PyInstaller onedir)
        run: |
          pyinstaller --noconfirm --windowed --onedir ^
            --name MusicCut ^
            --add-data "vlc;vlc" ^
            main.py

      - name: Package artifact
        shell: pwsh
        run: |
          $out = "MusicCut-${{ matrix.arch }}.zip"
          Compress-Archive -Path "dist/MusicCut/*" -DestinationPath $out -Force

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: MusicCut-${{ matrix.arch }}
          path: MusicCut-${{ matrix.arch }}.zip
